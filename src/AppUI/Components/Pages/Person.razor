@page "/person"

@using Services;
@using Shared.Infrastructure.Database.Entities;
@using Components.Dialogs;

@inject IDialogService dialogService;
@inject ISnackbar snackbar;
@inject CancellationTokenSource cts;
@inject MinimalDataService dataService;

<MudDataGrid T="PersonEntity" Items="@elements" SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@QuickSearch"
Hideable="true" ReadOnly="false" EditMode="DataGridEditMode.Form" EditTrigger="DataGridEditTrigger.OnRowClick" Bordered ="true"
Virtualize="true" FixedHeader="true" FixedFooter="true" SelectedItemChanged="@(person => this.selectedPerson = person)"
Height="450px">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Personenverwaltung</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Suche" Adornment="Adornment.Start"
        Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <Columns>
        <SelectColumn T="PersonEntity" />
        <PropertyColumn Property="x => x.FirstName" Title="Vorname" />
        <PropertyColumn Property="x => x.LastName" Title="Nachname" />
        <PropertyColumn Property="x => x.BirthDate" Title="Geburtsdatum">
            <EditTemplate Context="person">
                <MudDatePicker Label="Geburtsdatum"
                Date="@(person.Item.BirthDate.HasValue 
                        ? person.Item.BirthDate.Value.ToDateTime(new TimeOnly(0, 0)) 
                        : (DateTime?)null)"
                DateChanged="@(newDate => person.Item.BirthDate = newDate.HasValue 
                        ? DateOnly.FromDateTime(newDate.Value) 
                        : null)"
                Mask="@(new DateMask("dd.MM.yyyy"))"
                DateFormat="dd.MM.yyyy" RelativeWidth="DropdownWidth.Adaptive" />
            </EditTemplate>
        </PropertyColumn>

        <TemplateColumn Title="Adressen" Hidden="true" Editable="true">
            <EditTemplate Context="person">
                <MudText Typo="Typo.h6">Adressen</MudText>
                <MudDataGrid T="AddressEntity" Items="@person.Item.Addresses"
                EditMode="DataGridEditMode.Form" Bordered="true" ReadOnly="false" EditTrigger="DataGridEditTrigger.OnRowClick"
                Hideable="true" SortMode="SortMode.Multiple" SelectedItemChanged="@(address => this.selectedAddress = address)">
                    <Columns>
                        <SelectColumn T="AddressEntity" />
                        <PropertyColumn Property="x => x.Street" Title="Straße" />
                        <PropertyColumn Property="x => x.HouseNumber" Title="Hausnummer" />
                        <PropertyColumn Property="x => x.City" Title="Stadt" />
                        <PropertyColumn Property="x => x.ZipCode" Title="PLZ" />
                        <PropertyColumn Property="x => x.AdditionalInfo" Title="Zusatzinfo" />
                    </Columns>
                    <PagerContent>
                        <MudButton OnClick="@(() => OpenAddAddressDialog(person.Item))" 
                        Color="Color.Primary" Variant="Variant.Filled">Hinzufügen</MudButton>
                        <MudButton OnClick="@(() => DeleteAddress(person.Item))" 
                        Color="Color.Error" Variant="Variant.Filled">Löschen</MudButton>
                    </PagerContent>
                </MudDataGrid>
            </EditTemplate>
        </TemplateColumn>

        <TemplateColumn Title="Telefonverbindungen" Hidden="true" Editable="true">
            <EditTemplate Context="person">
                <MudText Typo="Typo.h6">Telefonverbindungen</MudText>
                <MudDataGrid T="TelephoneConnectionEntity" Items="@person.Item.TelephoneConnections" 
                    EditMode="DataGridEditMode.Form" EditTrigger="DataGridEditTrigger.OnRowClick" Bordered="true" ReadOnly="false" Hideable="true" 
                    SortMode="SortMode.Multiple" SelectedItemChanged="@(connection => this.selectedConnection = connection)">
                    <Columns>
                        <SelectColumn T="TelephoneConnectionEntity" />
                        <PropertyColumn Property="x => x.PhoneNumber" Title="Telefonnummer" />
                    </Columns>
                    <PagerContent>
                        <MudButton OnClick="@(() => OpenAddTelephoneConnectionDialog(person.Item))" 
                        Color="Color.Primary" Variant="Variant.Filled">Hinzufügen</MudButton>
                        <MudButton OnClick="@(() => DeleteConnection(person.Item))" 
                        Color="Color.Error" Variant="Variant.Filled">Löschen</MudButton>
                    </PagerContent>
                </MudDataGrid>
            </EditTemplate>
        </TemplateColumn>
    </Columns>

    <PagerContent>
        <MudButton Color="Color.Info" Variant="Variant.Filled">Daten laden</MudButton>
        <MudButton OnClick="@OpenAddPersonDialog" Color="Color.Primary" Variant="Variant.Filled">Hinzufügen</MudButton>
        <MudButton OnClick="@DeletePerson" Color="Color.Error" Variant="Variant.Filled">Löschen</MudButton>
    </PagerContent>
</MudDataGrid>

@code
{
    private List<PersonEntity> elements = new List<PersonEntity>
    {
        // new PersonEntity { FirstName = "Test", LastName = "User", BirthDate = DateOnly.FromDateTime(DateTime.Parse("02.02.2022"))},
        // new PersonEntity { FirstName = "Peter", LastName = "Lustig" },
        // new PersonEntity { FirstName = "Verrückter", LastName = "Typ", BirthDate = DateOnly.FromDateTime(DateTime.Parse("01.01.2011")) },
    };

    private string searchString = string.Empty;
    private AddressEntity? selectedAddress;
    private TelephoneConnectionEntity? selectedConnection;
    private PersonEntity? selectedPerson;

    protected override async Task OnInitializedAsync()
    {
        this.elements.AddRange(await this.dataService.GetAllPeople(this.cts.Token));
    }

    private Func<PersonEntity, bool> QuickSearch => x =>
    {
        if (string.IsNullOrEmpty(searchString))
        {
            return true;
        }

        if (x.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (x.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if ($"{x.FirstName} {x.LastName}".Contains(searchString, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (DateTime.TryParse(searchString, out var dateTime) 
            && x.BirthDate.HasValue 
            && DateOnly.FromDateTime(dateTime) is DateOnly dateOnly 
            && (x.BirthDate == dateOnly 
                || x.BirthDate.Value.Year == dateOnly.Year 
                || x.BirthDate.Value.Month == dateOnly.Month
                || x.BirthDate.Value.Day == dateOnly.Day))
        {
            return true;
        }

        return false;
    };

    private async Task OpenAddAddressDialog(PersonEntity person)
    {
        var result = await this.OpenDialog<AddressEntity, AddressDialog>("address");

        if (result is { } address)
        {
            person.Addresses.Add(address);
        }
    }

    private async Task OpenAddTelephoneConnectionDialog(PersonEntity person)
    {
        var resultData = await this.OpenDialog<TelephoneConnectionEntity, TelephoneConnectionDialog>("connection");

        if (resultData is { } connection)
        {
            person.TelephoneConnections.Add(connection);
        }
    }

    private async Task OpenAddPersonDialog()
    {
        var resultData = await this.OpenDialog<PersonEntity, PersonDialog>("person");

        if (resultData is { } person)
        {
            this.elements.Add(person);
        }
    }

    private async Task<TEntity?> OpenDialog<TEntity, TDialogType>(
        string propertyName, 
        string? dialogTitle = null)
        where TDialogType : IComponent
        where TEntity : class, new()
    {
        var newEntity = new TEntity();

        var dialogParams = new DialogParameters { [propertyName] = newEntity };
        var dialog = await this.dialogService.ShowAsync<TDialogType>(
            dialogTitle ?? $"Neue {typeof(TEntity).Name} hinzufügen",
            dialogParams,
            this.GetDialogOptions());

        var result = await dialog.Result;

        if ((result?.Canceled ?? false))
        {
            return null;
        }

        return (TEntity?)result?.Data;
    }

    private DialogOptions GetDialogOptions()
    {
        return new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
    }

    private void DeleteAddress(PersonEntity person)
    {
        if (this.selectedAddress is null)
        {
            return;
        }

        person.Addresses.Remove(this.selectedAddress);

        this.selectedAddress = null;
    }

    private void DeleteConnection(PersonEntity person)
    {
        if (this.selectedConnection is null)
        {
            return;
        }

        person.TelephoneConnections.Remove(this.selectedConnection);

        this.selectedConnection = null;
    }

    private void DeletePerson()
    {
        if (this.selectedPerson is null)
        {
            return;
        }

        if (this.selectedPerson.TelephoneConnections.Count > 0 || this.selectedPerson.Addresses.Count > 0)
        {
            this.snackbar.Add(
                "Person konnte nicht gelöscht werden, da noch verknüpfte Telefonverbindungen oder Adressen existieren", 
                Severity.Error);

            return;
        }

        this.elements.Remove(this.selectedPerson);

        this.snackbar.Add($"Person {this.selectedPerson} wurde erfolgreich gelöscht", Severity.Success);

        this.selectedPerson = null;
    }
}
